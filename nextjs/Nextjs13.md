# Next.js 13

<!-- TOC -->

- [Next.js 13](#nextjs-13)
  - [App Router 初期ファイル](#app-router-初期ファイル)
  - [Google Fonts](#google-fonts)
  - [fetch cache option](#fetch-cache-option)
  - [loading と error の表示](#loading-と-error-の表示)
    - [コンポーネント単位での表示](#コンポーネント単位での表示)
  - [Server component and Client component](#server-component-and-client-component)
  - [データの再取得](#データの再取得)
  <!-- TOC -->

## App Router 初期ファイル

- app
  - favicon.ico
  - global.css
  - layout.tsx
  - page.tsx
- ...

layout.tsx

```tsx
import "./globals.css";

export const metadata = {
  title: "Next.js 13",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  );
}
```

page.tsx

```tsx
export default function Page() {
  return (
    <main>
      <div className="m-10 text-center">Hello Next.js 13</div>
    </main>
  );
}
```

## Google Fonts

使用したいページを以下に変更。ページ全体に追加したいときは、layout.tsx を変更する。

```tsx
import "./globals.css";
import { Montserrat } from "next/font/google";

const MontserratFont = Montserrat({ subsets: ["latin"] });

export const metadata = {
  title: "Next.js 13",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={MontserratFont.className}>{children}</body>
    </html>
  );
}
```

## fetch cache option

fetch 関数の cache オプションを変更することで、ssg や ssr 等に変更できる。

```ts
// build時に取得したデータ(default)
// Similar to getStaticProps
fetch(URL, { cache: "force-cache" });

// ダイナミックにデータを取得する場合
// Similar to getServerSideProps
fetch(URL, { cache: "no-cache" });

// データを取得してから10秒間はキャッシュを使用する
// ISR
fetch(URL, { next: { revalidate: 10 } });
```

## loading と error の表示

page.tsx と同じ階層に、loading.tsx と error.tsx を作成する。

loading.tsx

```tsx
import Spinner from "@/app/components/spinner";

export default function Loading() {
  return <Spinner />;
}
```

spinner.tsx

```tsx
export default function Spinner({
  color = "border-blue-500",
}: {
  color?: string;
}) {
  {
    return (
      <div className="my-16 flex justify-center">
        <div
          className={`h-10 w-10 animate-spin rounded-full border-4 ${color} border-t-transparent`}
        />
      </div>
    );
  }
}
```

error.tsx

```tsx
"use client";

export default function Error({ error }: { error: Error }) {
  return (
    <div>
      <p className="mt-6 text-center text-red-500">
        Data fetching in server failed.
        <br />
        Error: {error.message}
      </p>
    </div>
  );
}
```

### コンポーネント単位での表示

page.tsx

```tsx
import NotesList from "@/app/components/notes-lits";
import TimerCounter from "@/app/components/timer-counter";
import { Suspense } from "react";
import Spinner from "@/app/components/spinner";

export default function Page() {
  return (
    <main>
      <div className="m-10 text-center">
        Hello Next.js 13
        <Suspense fallback={<Spinner color="border-green-500" />}>
          <NotesList />
        </Suspense>
        <TimerCounter />
      </div>
    </main>
  );
}
```

## Server component and Client component

- Server component
  - サーバーでレンダリングされる（js は client に送られない）
  - Data fetch に async function を使用できる
  - Secure key を使用可能
  - Browser の API を使用できない
  - useState, useEffect を使用できない
  - Event handler を使用できない
- Client component
  - js は client に送られる
  - Data fetch に async function を使用できない
    - useEffect, React-query 等を使用する
  - Secure key を使用できない
  - Browser の API を使用できる
  - useState, useEffect を使用できる
  - Event handler を使用できる

## データの再取得

データの再取得には、useRouter を使用する。useRouter は client component でのみ使用できる。<br />
useState の値はリセットされない。

refresh-button.tsx

```tsx
"use client";
import { useRouter } from "next/navigation";

export default function RefreshButton() {
  const router = useRouter();
  return (
    <button
      className="rounded bg-indigo-600 px-3 py-1 font-medium text-white hover:bg-indigo-700"
      onClick={() => {
        router.refresh();
      }}
    >
      Refresh current route
    </button>
  );
}
```

page.tsx

```tsx
import NotesList from "@/app/components/notes-lits";
import TimerCounter from "@/app/components/timer-counter";
import { Suspense } from "react";
import Spinner from "@/app/components/spinner";
import RefreshButton from "@/app/components/refresh-button";

export default function Page() {
  return (
    <main>
      <div className="m-10 text-center">
        Hello Next.js 13
        <Suspense fallback={<Spinner color="border-green-500" />}>
          <NotesList />
        </Suspense>
        <TimerCounter />
        <RefreshButton />
      </div>
    </main>
  );
}
```

## Dynamic route

フォルダ階層

```text
app
├ blogs
  ├ layout.tsx
  ├ page.tsx
  └ [blogId]
    └ page.tsx
```

params.フォルダ名 で、フォルダ名を取得できる。

blogs/[blogId]/page.tsx

```tsx
import Link from "next/link";
import { notFound } from "next/navigation";
import { format } from "date-fns";
import { ArrowUturnLeftIcon } from "@heroicons/react/24/solid";
import type { Database } from "@/database.types";

type Blog = Database["public"]["Tables"]["blogs"]["Row"];

type PageProps = {
  params: {
    blogId: string;
  };
};

async function fetchBlog(blogId: string) {
  const res = await fetch(
    `${process.env.url}/rest/v1/blogs?id=eq.${blogId}&select=*`,
    {
      headers: new Headers({
        apikey: process.env.apikey as string,
      }),
      cache: "no-store",
    }
  );

  if (!res.ok) {
    throw new Error("Failed to fetch data in server");
  }

  const blogs: Blog[] = await res.json();
  return blogs[0];
}

export default async function BlogDetailPage({ params }: PageProps) {
  console.log("params", params);

  const blog = await fetchBlog(params.blogId);
  if (!blog) return notFound();
  return (
    <div className="mt-16 p-8">
      <p>
        <strong className="mr-3">Task ID:</strong> {blog.id}
      </p>
      <p>
        <strong className="mr-3">Title:</strong> {blog.title}
      </p>
      <p>
        <strong className="mr-3">Content:</strong> {blog.content}
      </p>
      <p>
        <strong className="mr-3">Created at:</strong>
        {blog && format(new Date(blog.created_at), "yyyy-MM-dd HH:mm:ss")}
      </p>
      <Link href={`/blogs`}>
        <ArrowUturnLeftIcon className="mt-3 h-6 w-6 cursor-pointer text-blue-500" />
      </Link>
    </div>
  );
}
```
